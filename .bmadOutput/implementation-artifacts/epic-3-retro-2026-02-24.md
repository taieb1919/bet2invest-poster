# Rétrospective Épique 3 : Sélection, Publication et Historique

**Date :** 2026-02-24
**Facilitateur :** Bob (Scrum Master)
**Participants :** Bob (SM), Alice (PO), Charlie (Dev Senior), Amelia (Dev), Dana (QA), Elena (Junior Dev), taieb (Project Lead)

## Résumé de l'Épique

- **Stories livrées :** 3/3 (100%)
  - Story 3.1 : HistoryManager — Stockage, Doublons et Purge
  - Story 3.2 : BetSelector — Sélection Aléatoire
  - Story 3.3 : BetPublisher et PostingCycleService — Publication et Orchestration
- **Tests :** 79 passent (51 début → 79 fin), 0 régression
- **Issues review :** 16 identifiés, 16 corrigés, 0 en suivi
- **Agents dev :** claude-sonnet-4-6 (dev) et claude-opus-4-6 (review) — rotation maintenue

## FRs couvertes

| FR | Description | Story |
|---|---|---|
| FR7 | Sélection aléatoire 5, 10 ou 15 pronostics | 3.2 |
| FR8 | Détection doublons via history.json | 3.1 + 3.2 |
| FR9 | Publication via API bet2invest | 3.3 |
| FR10 | Enregistrement dans history.json | 3.1 + 3.3 |

## NFRs couvertes

| NFR | Description | Story |
|---|---|---|
| NFR4 | Écriture atomique history.json (write-to-temp + rename) | 3.1 |

## Ce qui a bien marché

### 1. Pipeline complet fonctionnel — milestone majeur
Le cycle purge → fetch tipsters → fetch bets → select → publish est entièrement connecté et testé. `PostingCycleService` orchestre le tout proprement sans logique métier — séparation des responsabilités exemplaire.

### 2. Croissance tests exemplaire (28 nouveaux)
- Story 3.1 : +11 → 62 tests (dont 3 ajoutés en review)
- Story 3.2 : +6 → 68 tests
- Story 3.3 : +11 → 79 tests
- 0 régression sur les 3 stories

### 3. Rotation dev/review agent — toujours efficace
- 3.1 : sonnet (dev) → opus (review) : 7 issues (4M/3L)
- 3.2 : sonnet (dev) → opus (review) : 4 issues (2M/2L)
- 3.3 : sonnet (dev) → opus (review) : 7 issues (2H/3M/2L)
- **Total : 16 issues trouvés et corrigés** — ROI de la review confirmé

### 4. Patterns techniques stables — aucune surprise
- Écriture atomique (File.Move overwrite) pour history.json — NFR4 satisfait
- Fakes manuels (nested class) — cohérent sur les 3 stories
- DI Scoped pour tous les services, LogContext.PushProperty pour les Steps
- `Random.Shared` thread-safe pour la sélection aléatoire

### 5. Résolution format betId
L'architecture définissait `"betId": "abc-123"` (string illustratif) mais `SettledBet.Id` est `int`. Résolu en story 3.1 — `HistoryEntry.BetId` est `int`. Aucun impact downstream.

## Ce qui peut s'améliorer

### 1. Tests du dev agent : assertions superficielles récurrentes
- Story 3.3 H2 : `PublishAllAsync_UsesBankrollIdFromOptions` ne vérifiait pas que le BankrollId était réellement passé au client — test placeholder qui passe même si le mapping est cassé
- Story 3.3 M3 : `RunCycleAsync_CallsPurgeFirst` ne vérifiait pas l'ordre réel d'appel — juste le count
- **Pattern :** le dev agent écrit des tests qui passent mais qui ne prouvent pas ce que leur nom promet

### 2. Error handling minimal dans l'orchestration
- Story 3.3 M1/M2 : `PostingCycleService` et `Worker` n'avaient aucun try/catch — une erreur dans n'importe quelle étape tuait le process sans log explicatif
- Corrigé en review (try/catch dans Worker), mais le dev agent devrait anticiper la gestion d'erreur en prod

### 3. Spike POST /v1/bet-orders toujours non fait
Action item #1 de la rétro Epic 2 — non réalisé. Le mapping `BetOrderRequest` est basé sur la rétro-ingénierie et n'a pas été validé avec de vrais credentials. Risque en production.

### 4. Security Checklist cochable — toujours non formalisée
Action item #2 de la rétro Epic 2 — non réalisé. Les stories 3.x n'ont pas de checklist sécurité cochable.

## Suivi Rétrospective Épique 2

### Action Items

| # | Action | Status | Preuve |
|---|---|---|---|
| 1 | Spike `POST /v1/bet-orders` avec vrais credentials | ❌ Non fait | BetPublisher implémenté sans validation réelle |
| 2 | Formaliser Security Checklist cochable | ❌ Non fait | Pas de checklist sécurité dans les stories 3.x |
| 3 | Lister edge cases dans exigences de test | ✅ Fait | Stories 3.x ont des tables de tests explicites avec patterns détaillés |

### Accords d'Équipe

| Accord | Status | Preuve |
|---|---|---|
| Rotation dev/review agent (sonnet↔opus) | ✅ | 3/3 stories reviewées avec rotation |
| Code reviews obligatoires | ✅ | 16 issues en 3 stories |
| Spike API documenté dans Dev Notes | ⏳ | Spike pas fait, donc rien à documenter |
| Edge cases explicites dans exigences test | ✅ | Tables de tests détaillées dans chaque story |

### Dette Technique Epic 2

| # | Item | Status |
|---|---|---|
| 1 | Worker.cs logge toutes les secondes | ✅ Résolu | Worker réécrit en story 3.3 (exécution unique) |
| 2 | Configs x64/x86 inutiles dans .sln | ⏳ Cosmétique, pas d'impact |
| 3 | Clarifier format betId (int vs string) | ✅ Résolu | Confirmé int en story 3.1 |

## Leçons Clés

1. **Les tests doivent prouver ce que leur nom promet** — un test `UsesBankrollIdFromOptions` doit vérifier le BankrollId dans le request, pas juste que le résultat est 1. Les fakes doivent capturer les arguments pour assertions profondes.
2. **L'error handling n'est pas optionnel pour un orchestrateur** — un service qui orchestre un pipeline complet DOIT avoir du try/catch avec logging. Le dev agent doit anticiper, pas attendre la review.
3. **Les actions items non suivis s'accumulent** — le spike API est reporté depuis Epic 2. Il faut le faire AVANT le premier test réel en production.
4. **L'écriture atomique (File.Move overwrite) est robuste et simple** — pattern validé pour history.json, réutilisable pour d'autres fichiers de données.
5. **Le pipeline est complet et testable** — 79 tests couvrent le cycle entier via des fakes, ce qui est un excellent filet de sécurité.

## Preview Epic 4 : Interface Telegram — Commandes et Notifications

### Stories planifiées
- **4.1** : Bot Telegram — Setup, Polling et Sécurité (FR19, FR20, NFR7, NFR10)
- **4.2** : Commandes /run et /status (FR14, FR15)
- **4.3** : NotificationService — Notifications automatiques (FR16, FR17, FR18)

### Dépendances sur Epic 3
- `PostingCycleService.RunCycleAsync()` ← Story 3.3 ✅
- Pipeline complet purge→fetch→select→publish ✅
- `Telegram.Bot 22.9.0` installé ← Story 1.1 ✅
- `TelegramOptions` (BotToken, AuthorizedChatId) ← Story 1.2 ✅

### Risques identifiés
- **Spike POST /v1/bet-orders non fait** — découverte possible d'un problème en prod si le body est incorrect
- **Worker.cs fait un seul cycle** — Epic 4 devra gérer la cohabitation entre le bot Telegram (long polling) et le cycle de publication
- **Long polling Telegram** — nécessite un BackgroundService dédié qui tourne en parallèle du Worker existant

### Préparation nécessaire
- Le Worker actuel devra évoluer pour supporter deux BackgroundServices (bot + cycle)
- `TelegramBotService` aura besoin d'un filtre d'autorisation par ChatId
- `/run` déclenchera `PostingCycleService` via scope DI depuis le handler Telegram

## Action Items

### Améliorations Processus

| # | Action | Owner | Deadline | Critère de succès |
|---|---|---|---|---|
| 1 | **Spike POST /v1/bet-orders avec vrais credentials** | taieb | Avant story 4.2 | Body validé, réponse API confirmée |
| 2 | Renforcer les assertions tests dans les stories : les fakes doivent capturer les arguments | Bob (SM) | Story 4.1 | Chaque test "Uses*" vérifie réellement l'argument passé |
| 3 | Exiger try/catch + logging dans tout service orchestrateur | Bob (SM) | Story 4.1 | Prescrit dans les exigences de chaque story d'orchestration |

### Dette Technique

| # | Item | Owner | Priorité | Notes |
|---|---|---|---|---|
| 1 | Configs x64/x86 inutiles dans .sln | Amelia (Dev) | Low | Cosmétique, reporté depuis Epic 1 |
| 2 | `BetPublisher` ne log pas les publications partielles avant échec | Amelia (Dev) | Low | Si le 3e bet échoue, les 2 premiers publiés ne sont pas loggés individuellement |

### Accords d'Équipe

- Maintenir la rotation dev/review agent (sonnet↔opus)
- Les code reviews restent obligatoires (16 issues en 3 stories — ROI confirmé)
- Les fakes de test doivent capturer les arguments pour des assertions profondes (pas juste des compteurs)
- Tout service orchestrateur doit avoir du try/catch avec logging structuré
- Le spike API `POST /v1/bet-orders` est une priorité absolue avant le premier test réel

## Readiness Assessment

| Dimension | Status | Notes |
|---|---|---|
| Tests & Qualité | ✅ | 79/79 tests, 0 régression, 16/16 issues corrigés |
| Déploiement | ⚠️ | Non déployé (infra prête, déploiement réel post-MVP) |
| Santé technique | ✅ | Build clean, pipeline complet, patterns stabilisés |
| Blocages | ⚠️ | Spike POST /v1/bet-orders toujours en attente |

## Préparation Epic 4

### Prérequis critiques
- [ ] Spike `POST /v1/bet-orders` avec vrais credentials (avant premier test réel)

### Préparation parallèle
- [ ] Étudier le pattern `TelegramBotClient` long polling avec `Telegram.Bot 22.9.0`
- [ ] Planifier la cohabitation Worker + TelegramBotService (deux BackgroundServices)

### Dépendances sur Epic 3
- PostingCycleService complet ✅
- Pipeline purge→fetch→select→publish ✅
- Telegram.Bot package installé ✅
- TelegramOptions configuré ✅

### Évaluation : PRÊT (avec réserve spike publication)
Le pipeline de publication est complet et testé. Le seul risque technique persistant est la validation du body POST /v1/bet-orders qui n'a pas été fait en conditions réelles.
