# Rétrospective Épique 5 : Automatisation Quotidienne et Résilience

**Date :** 2026-02-24
**Facilitateur :** Bob (Scrum Master)
**Participants :** Bob (SM), Alice (PO), Charlie (Dev Senior), Amelia (Dev), Dana (QA), Elena (Junior Dev), taieb (Project Lead)

---

## Résumé de l'Épique

- **Stories livrées :** 2/2 (100%)
  - Story 5.1 : SchedulerWorker — Exécution Quotidienne Planifiée (FR11, FR13)
  - Story 5.2 : Résilience Polly — Retry du Cycle Complet (FR12, FR18)
- **Tests :** 132 passent (116 début → 132 fin, +16 nouveaux), 0 régression
- **Issues review :** 9 identifiés, 9 corrigés (5 en 5.1 + 4 en 5.2), 0 en suivi
- **Agents dev :** claude-sonnet-4-6 (dev) et claude-opus-4-6 (review) — rotation maintenue

---

## FRs couvertes

| FR | Description | Story |
|---|---|---|
| FR11 | Exécution automatique quotidienne | 5.1 |
| FR12 | Retry en cas d'échec (3 tentatives) | 5.2 |
| FR13 | Configuration heure d'exécution | 5.1 |
| FR18 | Notification si toutes tentatives échouent | 5.2 |

## NFRs couvertes

| NFR | Description | Story |
|---|---|---|
| NFR2 | Taux de succès cycle quotidien > 95% | 5.2 (architectural) |

---

## Ce qui a bien marché

### 1. MVP entièrement livré — zéro intervention utilisateur atteint

Bob (Scrum Master): "C'est le dernier epic du MVP. Le système s'exécute automatiquement, retente en cas d'erreur, notifie taieb de tout ce qui se passe — et ne nécessite aucune intervention après configuration. C'est exactement ce qui était promis."

Alice (Product Owner): "Toutes les FRs sont couvertes : FR1 à FR23 implémentées, tous les epics done. C'est une vraie livraison."

Charlie (Senior Dev): "Architecturalement, Epic 5 est propre. Le pipeline Polly est isolé dans `ResiliencePipelineService`, le scope DI est correctement recréé à chaque tentative. On n'a pas contaminé `PostingCycleService` avec la logique de retry."

### 2. Décision architecturale clue — Polly dans les appelants, pas dans PostingCycleService

Charlie (Senior Dev): "Le fait d'avoir mis le pipeline Polly dans `SchedulerWorker` et `RunCommandHandler` plutôt que dans `PostingCycleService` était la bonne décision. Sinon chaque retry aurait déclenché `NotifyFailureAsync` — Telegram inondé de notifications intermédiaires."

Dana (QA): "Et PostingCycleService continue de notifier chaque échec intermédiaire, ce qui est le bon comportement. La notification finale FR18 est une couche supplémentaire uniquement quand toutes les tentatives sont épuisées."

### 3. `TimeProvider` abstraction — tests déterministes parfaits

Charlie (Senior Dev): "L'injection de `TimeProvider` pour le SchedulerWorker a permis des tests d'intégration parfaitement déterministes. `FakeTimeProvider.Advance()` déclenche les `Task.Delay` de manière synchrone — on n'a pas besoin de `Thread.Sleep` ou de timings fragiles."

Elena (Junior Dev): "J'ai appris ce pattern. C'est vraiment élégant pour tester du code dépendant du temps."

### 4. Review adversariale — H1 critique trouvé en 5.2

Bob (Scrum Master): "La review de la story 5.2 a trouvé un bug HIGH : `stoppingToken` passé à `NotifyFinalFailureAsync` aurait pu empêcher l'envoi de la notification finale dans un scénario d'arrêt gracieux. Corrigé en `CancellationToken.None`."

Alice (Product Owner): "Ce type de bug — correcteur de token mal passé — n'est pas évident à l'œil. C'est exactement ce pour quoi on fait des reviews adversariales."

### 5. Tests signal-based — fragility réduite

Bob (Scrum Master): "La review a aussi remplacé les `Task.Delay(300)` arbitraires dans `SchedulerWorkerPollyTests` par des `TaskCompletionSource`. Les tests sont maintenant déterministes et ne risquent pas de flaker sur un CI lent."

### 6. Couverture de tests exhaustive — 16 nouveaux tests, 0 régression

Dana (QA): "132 tests au total. La progression est cohérente : chaque story ajoute des tests ciblés sans régresser l'existant. Le baseline de 116 tests du début d'Epic 5 reste parfaitement stable."

---

## Ce qui peut s'améliorer

### 1. Champ mort `_logger` dans ResiliencePipelineService — erreur du dev agent

Charlie (Senior Dev): "En story 5.2, le dev agent a déclaré et assigné `_logger` comme champ de classe mais a utilisé le paramètre `logger` capturé par closure dans le callback `OnRetry`. Le champ était dead code — trouvé en review (M2)."

Bob (Scrum Master): "Pattern à retenir : quand un champ est assigné dans le constructeur mais jamais utilisé, c'est du code mort. Les compilateurs C# génèrent des warnings pour ça — ils auraient dû être vus."

### 2. Couverture Polly manquante pour RunCommandHandler — oubli de tests

Elena (Junior Dev): "La story 5.2 avait des tests Polly pour `SchedulerWorker` mais pas pour `RunCommandHandler`. La review (M3) a ajouté deux tests — fail→retry→success et exhaust→error message. Ce n'était pas un oubli mineur : Task 4 incluait explicitement l'intégration Polly dans RunCommandHandler."

Charlie (Senior Dev): "Le dev agent a créé le fichier `SchedulerWorkerPollyTests.cs` mais n'a pas créé l'équivalent pour RunCommandHandler. À l'avenir, les tests d'intégration doivent être écrits pour **chaque** intégration Polly, pas juste la première."

### 3. Spike POST /v1/bet-orders — 3e report consécutif

Bob (Scrum Master): "Le spike de validation de la vraie API n'a pas été fait. C'est le 3e epic de suite. Le MVP est livré mais jamais testé en conditions réelles de publication."

Alice (Product Owner): "C'est notre risque principal. Tout fonctionne en tests unitaires avec des fakes. La vraie question est : est-ce que `POST /v1/bet-orders` fonctionne avec le bon body en production ?"

taieb (Project Lead): "C'est effectivement la priorité absolue avant tout déploiement réel."

### 4. Duplication de fakes entre `SchedulerWorkerTests` et `SchedulerWorkerPollyTests`

Charlie (Senior Dev): "Les deux fichiers définissent des fakes similaires (`FakeNotificationService`, `FakeExecutionStateService`) avec des légères variantes. En review (L3), on a décidé de laisser — le couplage entre fichiers de test est pire que la duplication. Mais c'est un signe que les tests pourraient être mieux organisés si on avait plus de stories dans cet epic."

---

## Suivi Rétrospective Épique 4

### Action Items

| # | Action | Status | Preuve |
|---|---|---|---|
| 1 | **Spike POST /v1/bet-orders** avec vrais credentials | ❌ Non fait | 4e report consécutif — toujours pas validé |
| 2 | Dev agents réutilisent fakes `internal` existants | ⏳ Partiel | Story 5.2 review a encore trouvé une légère duplication dans les fakes. Le pattern est connu mais pas systématiquement respecté |
| 3 | `LogContext.PushProperty` scope englobe l'opération complète | ✅ Fait | Stories 5.1 et 5.2 : tous les `using (LogContext...)` englobent correctement log + action |

### Accords d'Équipe

| Accord | Status | Preuve |
|---|---|---|
| Rotation dev/review agent (sonnet↔opus) | ✅ | 2/2 stories reviewées avec rotation |
| Code reviews obligatoires | ✅ | 9 issues en 2 stories — ROI confirmé |
| `LogContext.PushProperty` scope complet | ✅ | Patterns corrects en 5.1 et 5.2 |
| Fakes `internal` réutilisés | ⏳ | Pattern connu mais pas systématique |
| Spike API priorité absolue | ❌ | Non fait — 4e report |

### Dette Technique Epic 4

| # | Item | Status |
|---|---|---|
| 1 | Configs x64/x86 inutiles dans .sln | ⏳ Cosmétique, toujours ouvert |
| 2 | BetPublisher ne log pas les publications partielles | ⏳ Non adressé |
| 3 | FR18 retryCount (TODO INotificationService) | ✅ Complété en story 5.2 (`NotifyFinalFailureAsync(int attempts, string reason)`) |

---

## Leçons Clés

1. **`CancellationToken` pour les notifications critiques — utiliser `CancellationToken.None`** : Passer `stoppingToken` à une notification envoyée dans un catch final peut empêcher l'envoi si le service s'arrête entre la dernière tentative et la notification. Pour toute notification "dernière chance" (FR18), utiliser `CancellationToken.None`.

2. **Tests d'intégration Polly exhaustifs** : Chaque composant qui intègre Polly doit avoir ses propres tests d'intégration. Ne pas se contenter de tester le premier — `SchedulerWorker` ET `RunCommandHandler` méritent leurs tests Polly respectifs.

3. **Champs `readonly` non utilisés = code mort** : Le compilateur C# génère des warnings pour les variables locales non utilisées mais pas toujours pour les champs. Un revue systématique des champs assignés dans le constructeur est nécessaire.

4. **`TaskCompletionSource` > `Task.Delay` dans les tests concurrents** : Pour tester du code concurrent (workers en background), les signaux déterministes via `TaskCompletionSource` éliminent les fragilités temporelles des `Task.Delay(N)` arbitraires.

5. **Le MVP est livré — le risque principal est opérationnel, pas technique** : Le code est testé et correct. Le risque restant est la validation en conditions réelles (spike API). Un MVP non déployé est un MVP dont on ne connaît pas les vrais problèmes.

---

## Découvertes Significatives

Aucune découverte significative ne remet en cause la direction technique. L'architecture est confirmée par l'implémentation complète :
- `ResiliencePipeline` de Polly.Core 8.6.5 fonctionne exactement comme prévu
- Le scope DI par tentative est correct et testé
- La séparation des responsabilités (PostingCycleService / SchedulerWorker / RunCommandHandler) est valide

**Pas d'epic update requis.** Le plan était correct.

---

## Readiness Assessment — Epic 5

| Dimension | Status | Notes |
|---|---|---|
| Tests & Qualité | ✅ | 132/132 tests, 0 régression, 9/9 issues corrigés |
| Déploiement | ⚠️ | Non déployé — infra prête, déploiement réel post-spike API |
| Santé technique | ✅ | Build clean, MVP complet, patterns stabilisés |
| Blocages | ⚠️ | **Spike POST /v1/bet-orders** — risque en production |

---

## Action Items

### Améliorations Processus

| # | Action | Owner | Critère de succès |
|---|---|---|---|
| 1 | **Spike POST /v1/bet-orders avec vrais credentials** | taieb | Body validé, réponse API confirmée, publication réelle vérifiée |
| 2 | Dev agents : tests Polly pour **chaque** composant intégrant Polly | Bob (SM) | Prescrit dans les exigences des prochaines stories |
| 3 | Auditer les champs readonly non utilisés avant review | Amelia (Dev) | 0 champ mort dans les nouvelles implémentations |

### Dette Technique

| # | Item | Owner | Priorité | Notes |
|---|---|---|---|---|
| 1 | Spike `POST /v1/bet-orders` (validation en conditions réelles) | taieb | **CRITIQUE** | 4e report — bloquant pour production |
| 2 | Configs x64/x86 inutiles dans .sln | Amelia (Dev) | Low | Cosmétique |
| 3 | BetPublisher ne log pas les publications partielles avant échec | Amelia (Dev) | Low | Non bloquant |

### Accords d'Équipe

- Maintenir la rotation dev/review agent (sonnet↔opus) — ROI confirmé sur 5 epics
- Tests d'intégration Polly : chaque composant intégrant Polly a ses propres tests
- `CancellationToken.None` pour les notifications critiques post-épuisement
- Le spike API est une **priorité absolue** avant tout déploiement réel

---

## Étapes Suivantes — Post-MVP

### Priorité immédiate

**1. Spike POST /v1/bet-orders** — taieb
- Déployer sur VPS de test avec vrais credentials
- Vérifier le body exact de la requête
- Confirmer la réponse API en conditions réelles
- Documenter les résultats

### Si le spike est concluant

**2. Déploiement production**
- `dotnet publish` + SCP/SSH vers `/opt/bet2invest-poster/`
- Configurer le service `systemd` avec les credentials via variables d'environnement
- Premier run réel à l'heure configurée

### Évolutions futures (hors MVP)

- Story 1.3 (déploiement VPS systemd) — story backlog non implémentée
- NFR9 (détection changement API bet2invest) — non adressé
- Dashboard de monitoring ou historique consultable via /status étendu

---

## Clôture

Bob (Scrum Master): "Epic 5 livre le dernier bloc du MVP. En 5 epics, on a construit de zéro un service .NET 9 qui s'authentifie sur bet2invest, sélectionne des pronostics, les publie, se planifie lui-même, retry en cas d'échec, et notifie via Telegram. 132 tests, 0 régression. C'est du travail solide."

Alice (Product Owner): "Toutes les FRs du PRD sont couvertes. Le MVP est livré comme prévu."

Charlie (Senior Dev): "La rotation dev/review agent a fonctionné du premier au dernier epic. 9 issues corrigés en Epic 5 — dont un HIGH qui aurait pu créer un bug silencieux en production. C'est la valeur de la review adversariale."

Dana (QA): "132 tests au total depuis 0. La base de code est solide et maintenable."

Bob (Scrum Master): "Le seul point d'ombre : le spike API repoussé 4 fois. C'est la seule chose qui nous sépare d'un déploiement en confiance. taieb — c'est dans tes mains maintenant."

taieb (Project Lead): "Compris. Spike priorité 1."

Bob (Scrum Master): "Session close. Bon travail à tous — MVP livré !"

═══════════════════════════════════════════════════════════
