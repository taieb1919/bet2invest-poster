# Rétrospective Épique 2 : Connexion API et Extraction des Pronostics

**Date :** 2026-02-24
**Facilitateur :** Bob (Scrum Master)
**Participants :** Bob (SM), Alice (PO), Charlie (Dev Senior), Amelia (Dev), Dana (QA), Elena (Junior Dev), taieb (Project Lead)

## Résumé de l'Épique

- **Stories livrées :** 3/3 (100%)
  - Story 2.1 : ExtendedBet2InvestClient — Authentification et Wrapper
  - Story 2.2 : Lecture des Tipsters (TipsterService)
  - Story 2.3 : Récupération des Paris à Venir (UpcomingBetsFetcher)
- **Tests :** 51 passent (11 début → 51 fin), 0 régression
- **Issues review :** 23 identifiés, 23 corrigés, 0 en suivi
- **Agents dev :** claude-sonnet-4-6 et claude-opus-4-6 (rotation systématique dev↔review)

## FRs couvertes

| FR | Description | Story |
|---|---|---|
| FR2 | Authentification automatique API bet2invest | 2.1 |
| FR3 | Renouvellement token si expiré | 2.1 |
| FR4 | Lecture liste tipsters depuis tipsters.json | 2.2 |
| FR5 | Récupération paris à venir (non résolus) | 2.3 |
| FR6 | Filtrage tipsters gratuits (free) | 2.2 + 2.3 (deux niveaux) |

## Ce qui a bien marché

### 1. Rétro-ingénierie API — breakthrough story 2.1
L'API bet2invest est privée et non documentée. L'architecture anticipait `GET /v1/statistics/{tipsterId}/bets/upcoming` — cet endpoint n'existe PAS. L'analyse du frontend Nuxt.js/Vue 3 a révélé :
- Paris pending dans `GET /v1/statistics/{tipsterId}` (champ `bets.pending`)
- Publication via `POST /v1/bet-orders`
- Endpoints supplémentaires : `GET /auth/me`, `POST /auth/refresh`, etc.

Cette recherche en story 2.1 a débloqué toute la suite de l'epic.

### 2. Rotation dev/review agent — qualité exemplaire
Chaque story développée par un modèle, reviewée par un autre :
- 2.1 : sonnet (dev) → opus (review) : 9 issues (2H/4M/3L)
- 2.2 : opus (dev) → sonnet (review) : 8 issues (3M/5L)
- 2.3 : sonnet (dev) → opus (review) : 6 issues (2H/2M/2L)

23 issues trouvés et corrigés au total. Aucun en suivi.

### 3. Croissance des tests exemplaire
- Epic 1 final : 11 tests
- Story 2.1 : +16 → 27 tests
- Story 2.2 : +13 → 40 tests
- Story 2.3 : +11 → 51 tests

Pattern de test cohérent : xUnit, stubs manuels (pas de Moq/NSubstitute), NullLogger, fichiers temporaires.

### 4. Patterns techniques stabilisés
- `CancellationToken ct = default` sur toutes les méthodes async
- `LogContext.PushProperty("Step", ...)` pour le logging structuré
- DI Scoped pour les services, Singleton pour Bet2InvestClient
- `System.Text.Json` avec `PropertyNameCaseInsensitive = true`
- Interface par service, un fichier par classe

## Ce qui peut s'améliorer

### 1. API non documentée — risque structurel
Le body de `POST /v1/bet-orders` est une approximation basée sur la rétro-ingénierie. Il n'a PAS été validé avec de vrais credentials. Story 3.3 (BetPublisher) dépend de cette méthode.

### 2. Dev agent oublie les edge cases tests (2/3 stories)
- Story 2.1 : `IsAuthenticated` ne vérifiait pas l'expiration token (corrigé en review)
- Story 2.3 : Test AC#3 testait `canSeeBets=false` avec bets vides — ne prouvait pas le filtrage réel (corrigé en review)

Le dev agent est solide sur le happy path mais rate les edge cases.

### 3. Security Checklist — action Epic 1 partiellement suivie
Les stories ont des sections "Conformité Architecture" détaillées couvrant la sécurité, mais pas de checklist cochable explicite comme demandé dans l'action item 1 de la rétro Epic 1.

## Suivi Rétrospective Epic 1

### Action Items

| # | Action | Status | Preuve |
|---|---|---|---|
| 1 | Checklist sécurité dans Dev Notes | ⏳ Partiel | Sécurité couverte dans "Conformité Architecture" mais pas en format checklist |
| 2 | Review adversariale modèle différent | ✅ Complété | Rotation systématique sonnet↔opus sur 3/3 stories |

### Accords d'Équipe

| Accord | Status | Preuve |
|---|---|---|
| Vérifier credentials, root, hardening, paths | ✅ | 0 issue sécurité dans les 23 findings de code review |
| Reviews adversariales sur stories infra/credentials | ✅ | 3/3 stories reviewées |
| File Lists complètes (incl. sprint-status.yaml) | ✅ | Toutes les stories documentent les fichiers modifiés |

### Dette Technique Epic 1

| # | Item | Status |
|---|---|---|
| 1 | Worker.cs logge toutes les secondes | ⏳ Sera résolu Epic 5 (SchedulerWorker) |
| 2 | Configs x64/x86 inutiles dans .sln | ⏳ Cosmétique, pas d'impact |

## Leçons Clés

1. **La rétro-ingénierie frontend est un skill critique** quand l'API est non documentée — investir en spike avant l'implémentation paie
2. **La rotation dev/review avec modèles différents est le meilleur investissement qualité** — 23 issues en 3 stories, dont des HIGH
3. **Les edge cases de test doivent être prescrits dans les stories** — pas découverts en code review
4. **Le pattern stub manuel (sans Moq)** fonctionne bien pour ce projet — simple et lisible
5. **L'abstraction via interfaces** (`IExtendedBet2InvestClient`) protège les couches supérieures des détails d'implémentation API

## Preview Epic 3 : Sélection, Publication et Historique

### Stories planifiées
- **3.1** : HistoryManager — stockage doublons et purge (history.json, écriture atomique, purge 30j)
- **3.2** : BetSelector — sélection aléatoire (5, 10 ou 15 pronostics)
- **3.3** : BetPublisher et PostingCycleService — publication et orchestration cycle complet

### Dépendances sur Epic 2
- `IExtendedBet2InvestClient.PublishBetAsync()` ← Story 2.1 ✅
- `UpcomingBetsFetcher.FetchAllAsync()` ← Story 2.3 ✅
- `TipsterService.LoadTipstersAsync()` ← Story 2.2 ✅
- Modèles `SettledBet`, `BetOrderRequest` ← disponibles ✅

### Risques identifiés
- **Body `POST /v1/bet-orders` non validé** — impact direct sur story 3.3
- **Format `betId`** — l'architecture définit `"betId": "abc-123"` (string) mais `SettledBet.Id` est un int — à clarifier pour story 3.1

## Action Items

### Améliorations Processus

| # | Action | Owner | Deadline | Critère de succès |
|---|---|---|---|---|
| 1 | Spike `POST /v1/bet-orders` avec vrais credentials | taieb | Avant story 3.3 | Body exact validé, bankrollId identifié |
| 2 | Formaliser la section "Security Checklist" en format checklist cochable | Bob (SM) | Story 3.1 | Chaque story a une checklist cochable |
| 3 | Lister les edge cases explicitement dans les exigences de test | Bob (SM) | Story 3.1 | Les cas limites prescrits, pas découverts en review |

### Dette Technique

| # | Item | Owner | Priorité | Notes |
|---|---|---|---|---|
| 1 | Worker.cs logge toutes les secondes | Amelia (Dev) | Low | Résolu quand SchedulerWorker le remplace (Epic 5) |
| 2 | Configs x64/x86 inutiles dans .sln | Amelia (Dev) | Low | Cosmétique |
| 3 | Clarifier format betId (int vs string) | Bob (SM) | Medium | Impacte story 3.1 (HistoryManager) |

### Accords d'Équipe

- Maintenir la rotation dev/review agent (sonnet↔opus)
- Les code reviews restent obligatoires (23 issues en 3 stories — ROI prouvé)
- Tout spike API doit être documenté dans les Dev Notes de la story
- Les edge cases doivent être EXPLICITEMENT listés dans les exigences de test

## Readiness Assessment

| Dimension | Status | Notes |
|---|---|---|
| Tests & Qualité | ✅ | 51/51 tests, 0 régression, 23/23 issues corrigés |
| Déploiement | ⚠️ | Non déployé (infra prête, déploiement réel post-MVP) |
| Santé technique | ✅ | Build clean, patterns stabilisés, 0 dette nouvelle |
| Blocages | ⚠️ | Spike `POST /v1/bet-orders` recommandé avant story 3.3 |

## Préparation Epic 3

### Prérequis critiques
- [ ] Spike `POST /v1/bet-orders` avec vrais credentials (avant story 3.3)

### Préparation parallèle
- [ ] Clarifier format `betId` (int vs string) pour HistoryManager
- [ ] Créer `Models/HistoryEntry.cs` (défini dans architecture, pas encore créé)

### Dépendances sur Epic 2
- `ExtendedBet2InvestClient` (auth + publish + upcoming) ✅
- `TipsterService` (lecture tipsters.json) ✅
- `UpcomingBetsFetcher` (agrégation paris) ✅
- Serilog structuré avec Steps ✅
- CI GitHub Actions ✅

### Évaluation : PRÊT (avec réserve spike publication)
Toutes les fondations sont solides. Le seul risque est la validation du body `POST /v1/bet-orders` avant story 3.3.
