# Rétrospective Épique 4 : Interface Telegram — Commandes et Notifications

**Date :** 2026-02-24
**Facilitateur :** Bob (Scrum Master)
**Participants :** Bob (SM), Alice (PO), Charlie (Dev Senior), Amelia (Dev), Dana (QA), Elena (Junior Dev), taieb (Project Lead)

## Résumé de l'Épique

- **Stories livrées :** 3/3 (100%)
  - Story 4.1 : Bot Telegram — Setup, Polling et Sécurité (FR19, FR20, NFR7, NFR10)
  - Story 4.2 : Commandes /run et /status (FR14, FR15)
  - Story 4.3 : NotificationService — Notifications automatiques (FR16, FR17, FR18 partiel)
- **Tests :** 116 passent (79 début → 116 fin), 0 régression
- **Issues review :** 21 identifiés, 21 corrigés, 0 en suivi
- **Agents dev :** claude-sonnet-4-6 (dev) et claude-opus-4-6 (review) — rotation maintenue

## FRs couvertes

| FR | Description | Story |
|---|---|---|
| FR14 | Commande /run exécution manuelle | 4.2 |
| FR15 | Commande /status état complet du système | 4.2 |
| FR16 | Notification succès Telegram | 4.3 |
| FR17 | Notification échec avec détail | 4.3 |
| FR18 | Notification retry complet (PARTIEL — dépend Polly Epic 5) | 4.3 |
| FR19 | Restriction accès par chat ID | 4.1 |
| FR20 | Ignorer commandes non autorisées | 4.1 |

## NFRs couvertes

| NFR | Description | Story |
|---|---|---|
| NFR3 | Notification < 5 min après événement | 4.3 |
| NFR5 | Credentials jamais dans logs/messages | 4.1, 4.2, 4.3 |
| NFR7 | 100% rejet commandes non autorisées | 4.1 |
| NFR10 | Retry backoff interruptions Telegram | 4.1 |

## Ce qui a bien marché

### 1. Module Telegram complet et cohérent — milestone majeur
Le bot Telegram est entièrement fonctionnel : polling sécurisé, commandes /run et /status, notifications automatiques. L'architecture Telegram/ avec ses sous-dossiers Commands/ et Formatters/ est propre et extensible.

### 2. Croissance tests impressionnante (37 nouveaux)
- Story 4.1 : +6 → 85 tests
- Story 4.2 : +18 → 103 tests
- Story 4.3 : +13 → 116 tests (dont +1 en review)
- 0 régression sur les 3 stories

### 3. Rotation dev/review agent — ROI confirmé encore une fois
- 4.1 : sonnet (dev) → opus (review) : 6 issues (3M/3L)
- 4.2 : sonnet (dev) → opus (review) : 8 issues (2H/4M/2L)
- 4.3 : sonnet (dev) → opus (review) : 7 issues (2H/3M/2L)
- **Total : 21 issues trouvés et corrigés** — cohérent avec Epic 3 (16 issues)

### 4. Pattern `ITelegramBotClient` DI — refactoring réussi
La transition de la création interne du `TelegramBotClient` vers l'injection DI en Singleton (story 4.3) a été propre. Le client est maintenant partagé entre `TelegramBotService` (polling) et `NotificationService` (envoi sortant) — exactement ce que l'architecture prescrit.

### 5. FakeTelegramBotClient réutilisable
Le fake créé en story 4.2 a été réutilisé avec succès en 4.3 (enrichi avec `SentChatIds` en review). Ce pattern de fake partagé réduit la duplication.

### 6. Sanitize error messages — leçon apprise et appliquée
La correction H2 de la review 4.2 (utiliser `ex.GetType().Name` au lieu de `ex.Message` dans les notifications) a été directement intégrée dans la story 4.3 dès la rédaction. La leçon de sécurité a été absorbée.

## Ce qui peut s'améliorer

### 1. Duplication de fakes entre fichiers de test — pattern récurrent
Story 4.3 a dupliqué 7 classes fake entre `PostingCycleServiceTests` et `PostingCycleServiceNotificationTests`. Corrigé en review (M1), mais le dev agent devrait réutiliser les fakes `internal` existants dès la première écriture.

### 2. `LogContext.PushProperty` scope mal placé — erreur subtile
Story 4.3 avait `SendMessage` en dehors du `using` de `LogContext.PushProperty`. Corrigé en review (H2). Ce type d'erreur est subtil mais important pour la traçabilité des logs.

### 3. FR18 (notification retry) reste partiel
L'interface `INotificationService.NotifyFailureAsync(string reason)` ne prend pas de paramètre `retryCount`. FR18 exige "le nombre de tentatives et l'erreur finale". Un TODO a été ajouté — ce sera complété en Epic 5 avec Polly.

### 4. Spike POST /v1/bet-orders — toujours non fait
Reporté depuis Epic 2 (2 rétrospectives de suite). Ce risque persiste.

## Suivi Rétrospective Épique 3

### Action Items

| # | Action | Status | Preuve |
|---|---|---|---|
| 1 | Spike POST /v1/bet-orders avec vrais credentials | ❌ Non fait | Toujours pas validé en conditions réelles |
| 2 | Renforcer les assertions tests : fakes capturent les arguments | ✅ Fait | `FakeTelegramBotClient` capture `SentMessages` et `SentChatIds` ; fakes 4.3 capturent `LastSuccessCount`, `LastFailureReason` |
| 3 | Exiger try/catch + logging dans tout service orchestrateur | ✅ Fait | `PostingCycleService` a un try/catch complet avec logging structuré et re-throw |

### Accords d'Équipe

| Accord | Status | Preuve |
|---|---|---|
| Rotation dev/review agent (sonnet↔opus) | ✅ | 3/3 stories reviewées avec rotation |
| Code reviews obligatoires | ✅ | 21 issues en 3 stories |
| Fakes capturent les arguments | ✅ | Pattern appliqué systématiquement |
| Try/catch dans orchestrateurs | ✅ | PostingCycleService, RunCommandHandler |
| Spike API priorité absolue | ❌ | Toujours non fait |

### Dette Technique Epic 3

| # | Item | Status |
|---|---|---|
| 1 | Configs x64/x86 inutiles dans .sln | ⏳ Cosmétique, reporté |
| 2 | BetPublisher ne log pas les publications partielles | ⏳ Non adressé |

## Leçons Clés

1. **Le scope `using` de `LogContext.PushProperty` doit englober toute l'opération** — pas juste le log mais aussi l'action qui peut échouer. Un `SendMessage` Telegram en dehors du scope perd le contexte de traçabilité.
2. **Les fakes `internal` doivent être réutilisés, pas dupliqués** — quand un fichier de test a des fakes `internal`, les autres fichiers du même assembly doivent les importer plutôt que les copier.
3. **L'injection DI d'un client partagé (Singleton) fonctionne bien** — la transition `TelegramBotClient` interne → `ITelegramBotClient` DI s'est faite proprement. Le pattern est validé.
4. **Les actions items non suivis s'accumulent dangereusement** — le spike API est reporté pour la 3e fois. C'est un risque réel en production.
5. **FR18 (retry notification) dépend d'Epic 5** — c'est OK de le marquer partiel tant que le TODO est documenté et l'interface est prête à évoluer.

## Preview Epic 5 : Automatisation Quotidienne et Résilience

### Stories planifiées
- **5.1** : SchedulerWorker — Exécution Quotidienne Planifiée (FR11, FR13)
- **5.2** : Résilience Polly — Retry du Cycle Complet (FR12, FR18)

### Dépendances sur Epic 4
- `PostingCycleService.RunCycleAsync()` avec try/catch et re-throw ← Story 4.3 ✅
- `IExecutionStateService.SetNextRun()` ← Story 4.2 ✅ (méthode prête, `NextRunAt` sera rempli par SchedulerWorker)
- `INotificationService.NotifyFailureAsync()` ← Story 4.3 ✅ (TODO FR18 retryCount à ajouter en 5.2)
- `Worker.cs` actuel exécute un seul cycle au démarrage — `SchedulerWorker` le remplacera

### Risques identifiés
- **Spike POST /v1/bet-orders non fait** — risque en production si le body est incorrect
- **FR18 retryCount** — l'interface `INotificationService` devra évoluer en story 5.2
- **Cohabitation Worker + SchedulerWorker + TelegramBotService** — 3 BackgroundServices en parallèle, gestion du lifecycle à clarifier
- **`PosterOptions.ScheduleTime`** — format de configuration à définir clairement

### Préparation nécessaire
- Comprendre le pattern `PeriodicTimer` ou `Task.Delay` pour le scheduling interne
- Planifier l'évolution de `Worker.cs` → `SchedulerWorker` (remplacement ou cohabitation)
- Préparer l'ajout de `retryCount` dans `INotificationService` pour FR18

## Action Items

### Améliorations Processus

| # | Action | Owner | Deadline | Critère de succès |
|---|---|---|---|---|
| 1 | **Spike POST /v1/bet-orders avec vrais credentials** | taieb | Avant story 5.1 | Body validé, réponse API confirmée |
| 2 | Les dev agents doivent réutiliser les fakes `internal` existants | Bob (SM) | Story 5.1 | 0 duplication de fakes entre fichiers de test |
| 3 | `LogContext.PushProperty` scope doit toujours englober l'opération complète | Bob (SM) | Story 5.1 | Prescrit dans les exigences de chaque story |

### Dette Technique

| # | Item | Owner | Priorité | Notes |
|---|---|---|---|---|
| 1 | Configs x64/x86 inutiles dans .sln | Amelia (Dev) | Low | Cosmétique, reporté depuis Epic 1 |
| 2 | BetPublisher ne log pas les publications partielles avant échec | Amelia (Dev) | Low | Reporté depuis Epic 3 |
| 3 | FR18 retryCount — TODO dans INotificationService | Charlie (Dev) | Medium | À compléter en story 5.2 |

### Accords d'Équipe

- Maintenir la rotation dev/review agent (sonnet↔opus)
- Les code reviews restent obligatoires (21 issues en 3 stories — ROI confirmé)
- Les fakes `internal` existants doivent être réutilisés (pas dupliqués)
- `LogContext.PushProperty` scope englobe toujours l'opération complète (log + action)
- Le spike API `POST /v1/bet-orders` est une priorité absolue — 3e report consécutif

## Readiness Assessment

| Dimension | Status | Notes |
|---|---|---|
| Tests & Qualité | ✅ | 116/116 tests, 0 régression, 21/21 issues corrigés |
| Déploiement | ⚠️ | Non déployé (infra prête, déploiement réel post-MVP) |
| Santé technique | ✅ | Build clean, module Telegram complet, patterns stabilisés |
| Blocages | ⚠️ | Spike POST /v1/bet-orders toujours en attente |

## Préparation Epic 5

### Prérequis critiques
- [ ] Spike `POST /v1/bet-orders` avec vrais credentials (avant premier test réel)

### Préparation parallèle
- [ ] Étudier les patterns de scheduling interne (.NET `PeriodicTimer` vs `Task.Delay` loop)
- [ ] Planifier l'évolution Worker.cs → SchedulerWorker
- [ ] Préparer l'ajout de `retryCount` dans `INotificationService` pour FR18 + Polly

### Dépendances sur Epic 4
- PostingCycleService avec try/catch + re-throw ✅
- IExecutionStateService.SetNextRun() prêt ✅
- INotificationService prêt (TODO FR18 retryCount) ✅
- Module Telegram complet (bot + commandes + notifications) ✅

### Évaluation : PRÊT (avec réserve spike publication)
Le module Telegram est complet et testé. Le pipeline de bout en bout (scrape → select → publish → notify) est fonctionnel. Le seul risque technique persistant est la validation du body POST /v1/bet-orders qui n'a pas été fait en conditions réelles — reporté pour la 3e fois.
